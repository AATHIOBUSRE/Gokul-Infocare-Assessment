{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Contact Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f5f7fa; padding:20px; }
    .error-input { border: 2px solid #dc3545 !important; }
    .error-message { color:#dc3545; font-size:.9rem; min-height:1.1rem; }
    .modal-header { background:#0d6efd; color:#fff; }
    table thead { background:#0d6efd; color:#fff; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">Contact Manager</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div></div>
    <button class="btn btn-primary" id="btnOpenAdd">+ Add Contact</button>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalTitle">Add Contact</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- General error messages here -->
          <div id="generalError" class="error-message mb-3"></div>

          <input type="hidden" id="contactId" />

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input id="firstName" class="form-control" />
              <div id="errorFirstName" class="error-message"></div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input id="lastName" class="form-control" />
              <div id="errorLastName" class="error-message"></div>
            </div>

            <div class="col-12">
              <label class="form-label">Address</label>
              <input id="address" class="form-control" />
              <div id="errorAddress" class="error-message"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input id="email" type="email" class="form-control" />
              <div id="errorEmail" class="error-message"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Phone Number</label>
              <input id="phoneNumber" class="form-control" maxlength="10" />
              <div id="errorPhoneNumber" class="error-message"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSave" class="btn btn-success">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- table -->
  <div class="card p-3">
    <h5>Contacts</h5>
    <div class="table-responsive mt-3">
      <table class="table table-striped table-bordered text-center">
        <thead>
          <tr>
            <th>First Name</th><th>Last Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="contactsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "/contact";
let editId = null;

const fieldMap = {
  FirstName: "firstName",
  LastName: "lastName",
  Address: "address",
  Email: "email",
  PhoneNumber: "phoneNumber"
};

function getCSRFToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta && meta.content) return meta.content;
  const c = document.cookie.match(/(^|;\\s*)csrftoken=([^;]+)/);
  return c ? decodeURIComponent(c[2]) : "";
}

function fetchWithCsrf(url, opts = {}) {
  opts.credentials = opts.credentials || "same-origin";
  opts.headers = opts.headers || {};
  if (opts.body && !opts.headers["Content-Type"]) opts.headers["Content-Type"] = "application/json";
  const method = (opts.method || "GET").toUpperCase();
  if (["POST","PUT","PATCH","DELETE"].includes(method)) {
    opts.headers["X-CSRFToken"] = getCSRFToken();
  }
  return fetch(url, opts);
}

function clearFieldErrors() {
  const generalErrorDiv = document.getElementById("generalError");
  if (generalErrorDiv) generalErrorDiv.innerText = "";
  Object.keys(fieldMap).forEach(k => {
    const errDiv = document.getElementById(`error${k}`);
    if (errDiv) errDiv.innerText = "";
    const input = document.getElementById(fieldMap[k]);
    if (input) input.classList.remove("error-input");
  });
}

function showFieldErrors(errJson) {
  const generalErrorDiv = document.getElementById("generalError");
  if (generalErrorDiv) generalErrorDiv.innerText = "";

  for (const field in errJson) {
    if (field === "non_field_errors") {
      const messages = errJson[field];
      const uniqueNameMsg = messages.find(msg => msg.includes("must make a unique set"));
      const friendlyMsg = uniqueNameMsg
        ? "First Name and Last Name already exist."
        : messages.join(", ");

      if (generalErrorDiv) {
        generalErrorDiv.innerText = friendlyMsg;
      } else {
        const div = document.getElementById("errorFirstName");
        if (div) div.innerText = friendlyMsg;
      }
      continue;
    }
    const key = field.replace(/Id$/, "");
    const errDiv = document.getElementById(`error${key}`);
    if (errDiv) errDiv.innerText = errJson[field].join(", ");
    if (fieldMap[key]) {
      const input = document.getElementById(fieldMap[key]);
      if (input) input.classList.add("error-input");
    }
  }
}

function escapeHtml(s) {
  if (s === null || s === undefined) return "";
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

async function loadContacts() {
  try {
    const res = await fetchWithCsrf(`${API_BASE}/getcontact/`, { method: "GET" });
    if (!res.ok) { console.error("Failed to load contacts:", res.status); return; }
    const data = await res.json();
    const tbody = document.getElementById("contactsTbody");
    tbody.innerHTML = "";
    data.forEach(c => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(c.FirstName)}</td>
          <td>${escapeHtml(c.LastName)}</td>
          <td>${escapeHtml(c.Address)}</td>
          <td>${escapeHtml(c.EmailId)}</td>
          <td>${escapeHtml(c.PhoneNumber)}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="openEdit(${c.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteContact(${c.id})">Delete</button>
          </td>
        </tr>
      `);
    });
  } catch(e) {
    console.error("Error loading contacts:", e);
  }
}

function openAdd() {
  editId = null;
  document.getElementById("modalTitle").innerText = "Add Contact";
  document.getElementById("contactId").value = "";
  ["firstName","lastName","address","email","phoneNumber"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = "";
  });
  clearFieldErrors();
  new bootstrap.Modal(document.getElementById("contactModal")).show();
}

async function openEdit(id) {
  try {
    const res = await fetchWithCsrf(`${API_BASE}/updatec/${id}`, { method: "GET" });
    if (!res.ok) { console.error("Failed to fetch contact:", res.status); return; }
    const data = await res.json();
    editId = id;
    document.getElementById("modalTitle").innerText = "Edit Contact";
    document.getElementById("contactId").value = id;
    document.getElementById("firstName").value = data.FirstName || "";
    document.getElementById("lastName").value = data.LastName || "";
    document.getElementById("address").value = data.Address || "";
    document.getElementById("email").value = data.EmailId || "";
    document.getElementById("phoneNumber").value = data.PhoneNumber || "";
    clearFieldErrors();
    new bootstrap.Modal(document.getElementById("contactModal")).show();
  } catch(e) {
    console.error("Error opening edit:", e);
  }
}

async function saveContact() {
  clearFieldErrors();

  const payload = {
    FirstName: document.getElementById("firstName").value.trim(),
    LastName: document.getElementById("lastName").value.trim(),
    Address: document.getElementById("address").value.trim(),
    EmailId: document.getElementById("email").value.trim(),
    PhoneNumber: document.getElementById("phoneNumber").value.trim()
  };

  const method = editId ? "PUT" : "POST";
  const url = editId ? `${API_BASE}/updatec/${editId}` : `${API_BASE}/getcontact/`;

  try {
    const res = await fetchWithCsrf(url, {
      method,
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let json = {};
      try { json = await res.json(); } catch(e) { console.error("Error parsing error JSON", e); }
      showFieldErrors(json);
      return;
    }

    // Success: hide modal and reload
    const modalEl = document.getElementById("contactModal");
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) modalInstance.hide();
    editId = null;
    loadContacts();
  } catch(e) {
    console.error("Error saving contact:", e);
  }
}

async function deleteContact(id) {
  if (!confirm("Are you sure you want to delete this contact?")) return;
  try {
    const res = await fetchWithCsrf(`${API_BASE}/updatec/${id}`, { method: "DELETE" });
    if (!res.ok) {
      console.error("Delete failed:", res.status);
      return;
    }
    loadContacts();
  } catch(e) {
    console.error("Error deleting contact:", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadContacts();
  document.getElementById("btnOpenAdd").addEventListener("click", openAdd);
  document.getElementById("btnSave").addEventListener("click", saveContact);
});
</script>
</body>
</html>
